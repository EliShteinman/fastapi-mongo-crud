### **קובץ הדרכה: `docs/09_statefulset_deployment_guide.md`**

#### **1. מטרת המדריך**

מדריך זה מסביר כיצד לפרוס את האפליקציה באמצעות **`StatefulSet`** עבור מסד הנתונים MongoDB. זוהי חלופה מתקדמת וחזקה יותר לפריסה הסטנדרטית המבוססת `Deployment`. מדריך זה מתמקד בהיגיון שמאחורי השינוי ובשלבי ההרצה המעשיים, מבלי להיכנס לקוד ה-YAML עצמו.

---

#### **2. למה להשתמש ב-`StatefulSet`?**

הפריסה הסטנדרטית עם `Deployment` עובדת מצוין עבור מופע בודד של MongoDB. עם זאת, בסביבות ייצור ולצורך התרחבות עתידית, `StatefulSet` הוא הבחירה הנכונה ממספר סיבות מרכזיות:

1.  **זהות רשת קבועה:** כל Pod שמנוהל על ידי `StatefulSet` מקבל שם DNS ייחודי וקבוע (למשל `mongo-db-statefulset-0`). זהות זו נשמרת גם אם ה-Pod מופעל מחדש. זה קריטי עבור מסדי נתונים שצריכים "למצוא" אחד את השני ברשת כדי להקים קלאסטר (Replica Set).
2.  **אחסון ייעודי וקבוע:** ה-`StatefulSet` יוצר באופן אוטומטי `PersistentVolumeClaim` (אחסון קבוע) ייחודי עבור כל Pod. ה-Pod הראשון תמיד יתחבר לאחסון הראשון, השני לשני, וכן הלאה. זה מבטיח שכל עותק של מסד הנתונים שומר על הנתונים שלו באופן עקבי.
3.  **סדר פעולות מבוקר:** `StatefulSet` מקפיד על סדר בעת יצירה, עדכון או מחיקה של Pods. הוא ימתין ש-Pod מספר 0 יהיה מוכן לחלוטין לפני שיתחיל ליצור את Pod מספר 1. סדר זה חיוני לפעולה תקינה של מערכות מבוזרות כמו קלאסטר מסדי נתונים.

בקיצור, `StatefulSet` הוא האובייקט שנועד ב-Kubernetes לנהל אפליקציות "עם מצב" (stateful) כמו MongoDB, ומספק את ההבטחות הנדרשות לסביבה יציבה ועמידה.

---

#### **3. השינויים המרכזיים בפריסה**

כדי לממש זאת, ביצענו מספר שינויים תשתיתיים:

*   **MongoDB:** במקום קבצי `Deployment` ו-`PVC` נפרדים, אנו משתמשים בקובץ `StatefulSet` אחד שמגדיר גם את הקונטיינר וגם את תבנית האחסון הנדרשת.
*   **רישות MongoDB:** במקום `Service` רגיל שמשמש כ-Load Balancer, אנו משתמשים ב-**`Headless Service`**. תפקידו אינו לנתב תעבורה, אלא לספק את רשומות ה-DNS היציבות שכל Pod ב-`StatefulSet` צריך.
*   **חיבור ה-API:** ה-Deployment של FastAPI עודכן כך שהוא מתחבר למסד הנתונים באמצעות שם ה-`Headless Service` החדש.

---

#### **4. איך פורסים באמצעות `StatefulSet`?**

יצרנו סקריפטים ייעודיים עבור פריסה זו. התהליך זהה לפריסה הרגילה, אך עם שימוש בסקריפטים עם הסיומת `-statefulset`.

**הנחות יסוד:**
*   התקנת את `oc` CLI ואתה מחובר לקלאסטר OpenShift.
*   התקנת את Docker והתחברת לחשבון Docker Hub שלך.
*   בחרת את הפרויקט הרצוי ב-OpenShift (`oc project <your-project-name>`).

**שלבי הפריסה:**

1.  **ודא שהסקריפטים ניתנים להרצה** (במידת הצורך):
    *   ב-Linux / macOS:
        ```bash
        chmod +x scripts/deploy-statefulset.sh
        ```

2.  **הרץ את הסקריפט המתאים למערכת ההפעלה שלך** מהתיקייה הראשית של הפרויקט, וספק את שם המשתמש שלך ב-Docker Hub כארגומנט:

    *   **עבור Linux / macOS:**
        ```bash
        ./scripts/deploy-statefulset.sh your-dockerhub-username
        ```

    *   **עבור Windows:**
        ```cmd
        scripts\deploy-statefulset.bat your-dockerhub-username
        ```

הסקריפט יבצע את כל הפעולות באופן אוטומטי: בניית האימג', דחיפתו, יצירת ה-`Secret`, פריסת ה-`StatefulSet` וה-`Headless Service` עבור MongoDB, המתנה להתייצבותם, פריסת ה-API, ולבסוף יצירת ה-`Route` וחשיפת הכתובת הסופית.
